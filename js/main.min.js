"use strict";const colors={greater100:"green",range40To100:"blue",range20To40:"orange",lower20:"red",noData:"darkgreen"},state={overLayers:{},baseLayers:{},center:[25.0850681831,121.564750671],title:document.getElementById("detailTitle"),content:document.getElementById("detailContent")},initMaps=mapId=>{state.map=L.map(mapId,{zoom:13,center:state.center,zoomControl:!0,attributionControl:!0}),state.baseLayers["國土測繪通用版電子地圖"]=L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP/default/EPSG:3857/{z}/{y}/{x}",{attribution:'<a href="https://maps.nlsc.gov.tw/">國土測繪圖資服務雲</a>'}).addTo(state.map),state.sidebar=L.control.sidebar({closeButton:!0,autopan:!0,container:"sidebar",position:"left"}).addTo(state.map).open("home"),L.control.locate().addTo(state.map),L.control.custom({position:"bottomright",content:'<div class="card shadow rounded map-legend-panel" style="padding: 5px"><dl>\n                    <dt style="font-size: 1.25rem"><span style="color:#6FAB25">●</span>：100個以上</dt>\n                    <dt style="font-size: 1.25rem"><span style="color:#36A5D6">●</span>：40個以上、低於100個</dt>\n                    <dt style="font-size: 1.25rem"><span style="color:#F1942F">●</span>：20個以上、低於40個</dt>\n                    <dt style="font-size: 1.25rem"><span style="color:#CD3B28">●</span>：低於20個</dt>\n                    <dt style="font-size: 1.25rem"><span style="color:#446677">●</span>：目前沒有資料</dt>\n                 </dl></div>'}).addTo(state.map),initGeoJsonPointLayer(),loadBackend(),state.map.on("move",(()=>{state.overLayers["健保藥局庫存"].clearLayers()})),state.map.on("moveend",(()=>{loadBackend()}))},initGeoJsonPointLayer=()=>{state.overLayers["健保藥局庫存"]=L.geoJson(null,{onEachFeature:(feature,layer)=>{layer.bindTooltip((layer=>`<b>藥局：</b>${layer.feature.properties.name}<br>\n                    <b>電話：</b>${layer.feature.properties.phone}<br>\n\t\t\t\t    <b>地址：</b>${layer.feature.properties.address}<br>\n                    <b>目前庫存：</b>${layer.feature.properties.stock}<br>\n                    <b>資料時間：</b>${layer.feature.properties.updateTime}`),{direction:"right",className:"map-tooltip",offset:[0,0]}),feature.properties,layer.on("click",(()=>{updateDetail(feature)}))},pointToLayer:(feature,latlng)=>{const stock=feature.properties.stock;let stockStyle;return stockStyle=stock>100?colors.greater100:stock>=40&&stock<=100?colors.range40To100:stock>=20&&stock<40?colors.range20To40:stock<20&&stock>=0?colors.lower20:colors.noData,L.marker(latlng,{icon:L.AwesomeMarkers.icon({prefix:"fa",icon:"hospital-o",markerColor:stockStyle})})}}).addTo(state.map)},loadBackend=()=>{const bbox=state.map.getBounds(),bboxPolygon=turf.bboxPolygon([bbox._southWest.lng,bbox._northEast.lat,bbox._northEast.lng,bbox._southWest.lat]);fetch("https://vipcube.github.io/opendata.gov.tw/rapidTestStock.json").then((response=>response.json())).then((features=>turf.pointsWithinPolygon(features,bboxPolygon))).then((features=>{if(state.overLayers["健保藥局庫存"]){const layer=state.overLayers["健保藥局庫存"];layer.clearLayers(),layer.addData(features)}}))},selectCountry=option=>{const array=option.value.split(",").map(Number);state.map.flyTo([array[0],array[1]],array[2])},updateDetail=feature=>{state.title.innerHTML=feature.properties.name,state.content.innerHTML=`\n    <table class="table-primary table-dark table-bordered" style="color: white; font-size: 1rem;">\n        <tbody>\n            <tr>\n              <th scope="row" style="width: 100px;">衛福部網址</th>\n              <td><a href="https://www.nhi.gov.tw/QueryN/Query3_Detail.aspx?HospID=${feature.properties.id}" target="_blank">院所明細</a></td>\n            </tr>\n            <tr>\n              <th scope="row">快篩庫存</th>\n              <td>${feature.properties.stock}</td>\n            </tr>\n            <tr>\n              <th scope="row">快篩品牌</th>\n              <td>${feature.properties.label}</td>\n            </tr>\n            <tr>\n              <th scope="row">備註</th>\n              <td>${feature.properties.remark}</td>\n            </tr>\n            <tr>\n              <th scope="row">電話</th>\n              <td>${feature.properties.phone}</td>\n            </tr>\n            <tr>\n              <th scope="row">地址</th>\n              <td>${feature.properties.address}</td>\n            </tr>\n            <tr>\n              <th scope="row">資料更新時間</th>\n              <td>${feature.properties.updateTime}</td>\n            </tr>\n        </tbody>\n    </table>\n    <hr />\n    <div class="btn-group-vertical" role="group" style="width: 100%;">\n        <a href="https://www.google.com/maps/dir/?api=1&destination=${feature.geometry.coordinates[1]},${feature.geometry.coordinates[0]}&travelmode=driving" target="_blank" class="btn btn-info btn-lg btn-block">Google 導航</a>\n    </div>\n    `,state.sidebar.open("detail")};